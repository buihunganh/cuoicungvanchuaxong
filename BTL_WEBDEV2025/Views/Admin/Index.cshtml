@{
    ViewData["Title"] = "ABDDT Admin";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var tab = Context.Request.Query["tab"].ToString();
    var isProducts = string.Equals(tab, "products", StringComparison.OrdinalIgnoreCase);
    var isCustomers = string.Equals(tab, "customers", StringComparison.OrdinalIgnoreCase);
    var isReport = string.Equals(tab, "report", StringComparison.OrdinalIgnoreCase);
    var isInventory = string.Equals(tab, "inventory", StringComparison.OrdinalIgnoreCase);
    ViewData["ActiveMenu"] = isInventory ? "inventory" : (isReport ? "report" : (isCustomers ? "customers" : (isProducts ? "products" : "dashboard")));
}
<div class="container-fluid px-4 my-4">
    @if (!isProducts && !isCustomers && !isInventory && !isReport) {
        <h1 class="fw-bold mb-4">Overview</h1>
        <div class="row g-4 mb-4">
            <div class="col-6 col-md-3">
                <div class="card shadow-sm bg-white text-dark h-100 border-0 rounded-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-1">
                            <div class="me-2"><i class="bi bi-bar-chart-line fs-4"></i></div>
                            <div>
                                <small class="text-muted">Revenue (USD)</small>
                                <div class="fs-4 fw-bold" id="stat-sales">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card shadow-sm bg-white text-dark h-100 border-0 rounded-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-1">
                            <div class="me-2"><i class="bi bi-cart fs-4"></i></div>
                            <div>
                                <small class="text-muted">Orders</small>
                                <div class="fs-4 fw-bold" id="stat-orders">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card shadow-sm bg-white text-dark h-100 border-0 rounded-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-1">
                            <div class="me-2"><i class="bi bi-people fs-4"></i></div>
                            <div>
                                <small class="text-muted">Customers</small>
                                <div class="fs-4 fw-bold" id="stat-customers">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card shadow-sm bg-white text-dark h-100 border-0 rounded-4">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-1">
                            <div class="me-2"><i class="bi bi-cash-coin fs-4"></i></div>
        <div>
                                <small class="text-muted">Profit</small>
                                <div class="fs-4 fw-bold" id="stat-profit">—</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card border-0 shadow-sm mb-4 rounded-4">
            <div class="card-body">
                <h5 class="mb-3 fw-bold">Revenue Chart</h5>
                <canvas id="salesChart" height="60"></canvas>
    </div>
        </div>
    }
    
    @if (isProducts) {
        <div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h1 class="fw-bold">Product Management</h1>
                <button class="btn btn-dark" id="btnAddProduct"><i class="bi bi-plus-lg"></i> Add Product</button>
            </div>
    <div class="table-responsive">
                <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Discount Price</th>
                            <th>Category</th>
                            <th>Image</th>
                            <th></th>
                </tr>
            </thead>
                    <tbody id="tableProducts"></tbody>
                </table>
            </div>
        </div>
    }

    @if (isInventory) {
        <div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1 class="fw-bold">Inventory</h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-dark" id="btnAddVariant"><i class="bi bi-plus-lg"></i> Add Variant</button>
                    <button class="btn btn-outline-secondary" id="btnReloadStock">Reload</button>
                </div>
            </div>
            <div class="mb-3">
                <div class="input-group" style="max-width: 400px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="inventorySearchInput" placeholder="Search by product name..." />
                    <button class="btn btn-outline-secondary" type="button" id="inventorySearchClear" style="display: none;">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>Variant ID</th>
                            <th>Product</th>
                            <th>Size</th>
                            <th>Color</th>
                            <th>Stock</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="tableInventory"></tbody>
                </table>
            </div>
        </div>
    }

    @if (isCustomers) {
        <div>
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h1 class="fw-bold">Customer Management</h1>
                <button class="btn btn-dark" id="btnAddCustomer"><i class="bi bi-person-plus"></i> Add Customer</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Full name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Date of birth</th>
                            <th></th>
                    </tr>
                    </thead>
                    <tbody id="tableCustomers"></tbody>
        </table>
    </div>
        </div>
    }

    @if (isReport) {
        <div>
            <div class="d-flex flex-wrap align-items-end gap-2 mb-3">
                <div>
                    <label class="form-label mb-1">From</label>
                    <input type="date" class="form-control" id="repFrom" />
                </div>
                <div>
                    <label class="form-label mb-1">To</label>
                    <input type="date" class="form-control" id="repTo" />
                </div>
                <button class="btn btn-dark" id="btnApplyReport">Apply</button>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-6 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">Revenue</small><div class="fs-4 fw-bold" id="rRevenue">$0</div></div></div></div>
                <div class="col-6 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">Orders</small><div class="fs-4 fw-bold" id="rOrders">0</div></div></div></div>
                <div class="col-6 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">Items</small><div class="fs-4 fw-bold" id="rItems">0</div></div></div></div>
                <div class="col-6 col-md-3"><div class="card border-0 shadow-sm"><div class="card-body"><small class="text-muted">AOV</small><div class="fs-4 fw-bold" id="rAov">$0</div></div></div></div>
            </div>
            <div class="card border-0 shadow-sm mb-4 rounded-4">
                <div class="card-body">
                    <h5 class="mb-3 fw-bold">Revenue by day</h5>
                    <canvas id="reportSeries" height="60"></canvas>
                </div>
            </div>
        </div>
    }
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalTitle">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="productForm" class="row g-3" enctype="multipart/form-data">
          <input type="hidden" id="pId" />
          <div class="col-12">
            <label class="form-label">Name</label>
            <input class="form-control" id="pName" required />
          </div>
          <div class="col-12">
            <label class="form-label">Description</label>
            <textarea class="form-control" id="pDescription" rows="2"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Price (USD)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="pPrice" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Discount Price (USD)</label>
            <input type="number" step="0.01" min="0" class="form-control" id="pDiscountPrice" />
            <small class="text-muted">Optional - leave empty if no discount</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Category</label>
            <select class="form-control" id="pCategoryId">
              <option value="">-- Select Category --</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Brand</label>
            <select class="form-control" id="pBrandId">
              <option value="">-- Select Brand --</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Product Image</label>
            <input type="file" class="form-control" id="pImageFile" accept="image/jpeg,image/jpg,image/png,image/webp" />
          </div>
          <div class="col-12" id="pImagePreviewContainer" style="display: none;">
            <label class="form-label">Current Image</label>
            <img id="pImagePreview" src="" alt="Preview" style="max-height: 150px; max-width: 100%;" />
            <div class="mt-2">
              <label class="form-label">Or enter Image URL</label>
              <input class="form-control" id="pImageUrl" placeholder="Leave empty if uploading file" />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" id="saveProductBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Inventory Variant Modal -->
<div class="modal fade" id="variantModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="variantModalTitle">Add Variant</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="variantForm" class="row g-3">
          <input type="hidden" id="vId" />
          <div class="col-12">
            <label class="form-label">Product</label>
            <select class="form-control" id="vProductId" required>
              <option value="">-- Select Product --</option>
            </select>
            <small class="text-muted" id="vProductIdNote" style="display: none;">Product cannot be changed when editing</small>
          </div>
          <div class="col-md-6">
            <label class="form-label">Size</label>
            <input class="form-control" id="vSize" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Color</label>
            <input class="form-control" id="vColor" required />
          </div>
          <div class="col-12">
            <label class="form-label">Stock Quantity</label>
            <input type="number" min="0" class="form-control" id="vStockQuantity" value="0" required />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" id="saveVariantBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerModalTitle">Add Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="customerForm" class="row g-3">
          <input type="hidden" id="cId" />
          <div class="col-12">
            <label class="form-label">Full name</label>
            <input class="form-control" id="cFullName" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="cEmail" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Phone</label>
            <input class="form-control" id="cPhone" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Date of birth</label>
            <input type="date" class="form-control" id="cDob" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-dark" id="saveCustomerBtn">Save</button>
      </div>
    </div>
  </div>
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
        async function fetchJson(url, opts) {
            const res = await fetch(url, Object.assign({ headers: { 'Content-Type': 'application/json' } }, opts));
            if (!res.ok) throw new Error(await res.text());
            return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
        }
        function fmtUSD(n){
            try { return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(n||0)); } catch { return `$${n}`; }
        }

        const isProducts = '@(isProducts)'.toLowerCase() === 'true';
        const isCustomers = '@(isCustomers)'.toLowerCase() === 'true';
        const isReport = '@(isReport)'.toLowerCase() === 'true';
        const isInventory = '@(isInventory)'.toLowerCase() === 'true';

        // Tổng quan: nạp stats + chart
        if (!isProducts && !isCustomers) {
            fetchJson('/admin/api/stats').then(s => {
                document.getElementById('stat-sales').textContent = fmtUSD(s.totalSales);
                document.getElementById('stat-orders').textContent = s.totalOrders;
                document.getElementById('stat-customers').textContent = s.totalCustomers;
                document.getElementById('stat-profit').textContent = fmtUSD(s.profit || s.totalSales);
            }).catch(function(error) { /* Stats fetch error */ });

            const ctx = document.getElementById('salesChart')?.getContext('2d');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: { labels: ['02.08','03.08','10.08','20.08','30.08'], datasets: [
                        {label:'Units sold',data:[4,6,6,3,1],borderColor:'#ef4a64',backgroundColor:'rgba(239,74,100,0.13)',tension:0.25},
                        {label:'Sales revenue',data:[2,5,6,4,2],borderColor:'#2062e9',backgroundColor:'rgba(32,98,233,0.13)',tension:0.25}
                    ]}, options:{ responsive:true, plugins:{ legend:{ display:true, position:'top' } } }
                });
            }
        }

        // Load brands
        let brandsList = [];
        async function loadBrands(){
            brandsList = await fetchJson('/admin/api/brands');
            const select = document.getElementById('pBrandId');
            if(select){
                select.innerHTML = '<option value="">-- Select Brand --</option>' + 
                    brandsList.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
            }
        }

        // Load categories
        let categoriesList = [];
        async function loadCategories(){
            categoriesList = await fetchJson('/admin/api/categories');
            const select = document.getElementById('pCategoryId');
            if(select){
                select.innerHTML = '<option value="">-- Select Category --</option>' + 
                    categoriesList.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        // Products: list + CRUD
        async function loadProducts(){
            const rows = await fetchJson('/admin/api/products');
            const tb = document.getElementById('tableProducts');
            if(!tb) return;
            tb.innerHTML = rows.map(p=>`
                <tr>
                  <td>${p.id}</td>
                  <td>${p.name}</td>
                  <td>${p.description||''}</td>
                  <td>${fmtUSD(p.price)}</td>
                  <td>${p.discountPrice ? fmtUSD(p.discountPrice) : '-'}</td>
                  <td>${p.category||''}</td>
                  <td>${p.imageUrl?`<img src="${p.imageUrl}" style="height:40px">`:''}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${p.id})">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})">Delete</button>
                  </td>
                </tr>`).join('');
        }
        // Product modal workflow
        const productModalEl = document.getElementById('productModal');
        const productModal = productModalEl ? new bootstrap.Modal(productModalEl) : null;
        function openProductModal(mode, data){
            document.getElementById('productModalTitle').textContent = mode === 'edit' ? 'Edit Product' : 'Add Product';
            document.getElementById('pId').value = data?.id||'';
            document.getElementById('pName').value = data?.name||'';
            document.getElementById('pDescription').value = data?.description||'';
            document.getElementById('pPrice').value = data?.price||0;
            document.getElementById('pDiscountPrice').value = data?.discountPrice||'';
            document.getElementById('pCategoryId').value = data?.categoryId||'';
            document.getElementById('pBrandId').value = data?.brandId||'';
            document.getElementById('pImageFile').value = '';
            const previewContainer = document.getElementById('pImagePreviewContainer');
            const previewImg = document.getElementById('pImagePreview');
            const imageUrlInput = document.getElementById('pImageUrl');
            if(data?.imageUrl){
                previewImg.src = data.imageUrl;
                previewContainer.style.display = 'block';
                imageUrlInput.value = data.imageUrl;
            } else {
                previewContainer.style.display = 'none';
                imageUrlInput.value = '';
            }
            productModal?.show();
        }
        async function saveProduct(){
            const id = document.getElementById('pId').value;
            const formData = new FormData();
            formData.append('name', document.getElementById('pName').value);
            formData.append('description', document.getElementById('pDescription').value);
            formData.append('price', document.getElementById('pPrice').value);
            const discountPrice = document.getElementById('pDiscountPrice').value;
            if(discountPrice) formData.append('discountPrice', discountPrice);
            const categoryId = document.getElementById('pCategoryId').value;
            if(categoryId) formData.append('categoryId', categoryId);
            const brandId = document.getElementById('pBrandId').value;
            if(brandId) formData.append('brandId', brandId);
            
            const imageFile = document.getElementById('pImageFile').files[0];
            if(imageFile){
                formData.append('imageFile', imageFile);
            } else if (id) {
                const imageUrl = document.getElementById('pImageUrl').value;
                if(imageUrl) formData.append('imageUrl', imageUrl);
            }

            try {
                if (id){
                    const res = await fetch(`/admin/api/products/update/${id}`, {
                        method: 'POST',
                        body: formData
                    });
                    if (!res.ok) throw new Error(await res.text());
                } else {
                    const res = await fetch('/admin/api/products/create', {
                        method: 'POST',
                        body: formData
                    });
                    if (!res.ok) throw new Error(await res.text());
                }
                productModal?.hide();
                await loadProducts();
            } catch(error) {
                alert('Error: ' + error.message);
            }
        }
        async function addProduct(){ openProductModal('add'); }
        async function editProduct(id){
            // Fetch full product data from API
            const products = await fetchJson('/admin/api/products');
            const product = products.find(p => p.id == id);
            if(product){
                openProductModal('edit', {
                    id: product.id,
                    name: product.name,
                    description: product.description,
                    price: product.price,
                    discountPrice: product.discountPrice,
                    categoryId: product.categoryId,
                    brandId: product.brandId,
                    imageUrl: product.imageUrl
                });
            } else {
                alert('Product not found');
            }
        }
        document.getElementById('saveProductBtn')?.addEventListener('click', saveProduct);
        async function deleteProduct(id){
            if(!confirm('Delete this product?')) return;
            await fetchJson(`/admin/api/products/delete/${id}`,{ method:'POST' });
            await loadProducts();
        }
        if (isProducts) {
            loadBrands();
            loadCategories();
            loadProducts();
            document.getElementById('btnAddProduct')?.addEventListener('click', addProduct);
            window.editProduct = editProduct; window.deleteProduct = deleteProduct; // expose for onclick
        }

        // Customers: list + CRUD
        async function loadCustomers(){
            const rows = await fetchJson('/admin/api/customers');
            const tb = document.getElementById('tableCustomers'); if(!tb) return;
            tb.innerHTML = rows.map(c=>`
                <tr>
                  <td>${c.id}</td>
                  <td>${c.fullName||''}</td>
                  <td>${c.email}</td>
                  <td>${c.phoneNumber||''}</td>
                  <td>${c.dateOfBirth? new Date(c.dateOfBirth).toLocaleDateString(): ''}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editCustomer(${c.id})">Edit</button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteCustomer(${c.id})">Delete</button>
                  </td>
                </tr>`).join('');
        }
        // Customer modal workflow
        const customerModalEl = document.getElementById('customerModal');
        const customerModal = customerModalEl ? new bootstrap.Modal(customerModalEl) : null;
        function openCustomerModal(mode, data){
            document.getElementById('customerModalTitle').textContent = mode === 'edit' ? 'Edit Customer' : 'Add Customer';
            document.getElementById('cId').value = data?.id||'';
            document.getElementById('cFullName').value = data?.fullName||'';
            document.getElementById('cEmail').value = data?.email||'';
            document.getElementById('cPhone').value = data?.phoneNumber||'';
            document.getElementById('cDob').value = data?.dateOfBirth ? data.dateOfBirth.substring(0,10) : '';
            customerModal?.show();
        }
        async function saveCustomer(){
            const id = document.getElementById('cId').value;
            const payload = {
                fullName: document.getElementById('cFullName').value,
                email: document.getElementById('cEmail').value,
                phoneNumber: document.getElementById('cPhone').value,
                dateOfBirth: document.getElementById('cDob').value || null
            };
            if (id){
                await fetchJson(`/admin/api/customers/update/${id}`,{ method:'POST', body: JSON.stringify(payload) });
            } else {
                await fetchJson('/admin/api/customers/create',{ method:'POST', body: JSON.stringify(payload) });
            }
            customerModal?.hide();
            await loadCustomers();
        }
        async function addCustomer(){ openCustomerModal('add'); }
        async function editCustomer(id){
            const row = [...document.querySelectorAll('#tableCustomers tr')].find(tr=>tr.firstElementChild?.textContent==id);
            const data = row ? {
                id,
                fullName: row.children[1].textContent,
                email: row.children[2].textContent,
                phoneNumber: row.children[3].textContent,
                dateOfBirth: row.children[4].textContent ? new Date(row.children[4].textContent).toISOString() : ''
            } : { id };
            openCustomerModal('edit', data);
        }
        document.getElementById('saveCustomerBtn')?.addEventListener('click', saveCustomer);
        async function deleteCustomer(id){
            if(!confirm('Delete this customer?')) return;
            await fetchJson(`/admin/api/customers/delete/${id}`,{ method:'POST' });
            await loadCustomers();
        }
        if (isCustomers) {
            loadCustomers();
            document.getElementById('btnAddCustomer')?.addEventListener('click', addCustomer);
            window.editCustomer = editCustomer; window.deleteCustomer = deleteCustomer;
        }

        // Load products for variant modal
        let productsList = [];
        async function loadProductsForInventory(){
            productsList = await fetchJson('/admin/api/products');
            const select = document.getElementById('vProductId');
            if(select){
                select.innerHTML = '<option value="">-- Select Product --</option>' + 
                    productsList.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
            }
        }

        // Inventory: list + CRUD + Search
        let allInventoryRows = [];
        async function loadInventory(){
            allInventoryRows = await fetchJson('/admin/api/inventory');
            renderInventoryTable();
        }
        
        function renderInventoryTable(filterText = ''){
            const tb = document.getElementById('tableInventory'); 
            if(!tb) return;
            
            const searchLower = filterText.toLowerCase().trim();
            const filtered = searchLower ? 
                allInventoryRows.filter(v => 
                    v.productName.toLowerCase().includes(searchLower) ||
                    v.size.toLowerCase().includes(searchLower) ||
                    v.color.toLowerCase().includes(searchLower) ||
                    v.productId.toString().includes(searchLower)
                ) : 
                allInventoryRows;
            
            if(filtered.length === 0 && searchLower){
                tb.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No variants found matching "${filterText}"</td></tr>`;
                return;
            }
            
            tb.innerHTML = filtered.map(v=>`
                <tr data-product-name="${v.productName.toLowerCase()}" data-product-id="${v.productId}">
                  <td>${v.id}</td>
                  <td>${v.productName} (#${v.productId})</td>
                  <td>${v.size}</td>
                  <td>${v.color}</td>
                  <td>${v.stockQuantity}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editVariant(${v.id})">Edit</button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteVariant(${v.id})">Delete</button>
                  </td>
                </tr>`).join('');
        }
        
        function setupInventorySearch(){
            const searchInput = document.getElementById('inventorySearchInput');
            const clearBtn = document.getElementById('inventorySearchClear');
            
            if(searchInput){
                searchInput.addEventListener('input', function(){
                    const query = this.value;
                    renderInventoryTable(query);
                    clearBtn.style.display = query ? 'block' : 'none';
                });
            }
            
            if(clearBtn){
                clearBtn.addEventListener('click', function(){
                    searchInput.value = '';
                    renderInventoryTable('');
                    this.style.display = 'none';
                });
            }
        }

        // Variant modal workflow
        const variantModalEl = document.getElementById('variantModal');
        const variantModal = variantModalEl ? new bootstrap.Modal(variantModalEl) : null;
        function openVariantModal(mode, data){
            document.getElementById('variantModalTitle').textContent = mode === 'edit' ? 'Edit Variant' : 'Add Variant';
            document.getElementById('vId').value = data?.id||'';
            const productSelect = document.getElementById('vProductId');
            const productNote = document.getElementById('vProductIdNote');
            if(mode === 'edit'){
                productSelect.value = data?.productId||'';
                productSelect.disabled = true;
                productNote.style.display = 'block';
            } else {
                productSelect.value = '';
                productSelect.disabled = false;
                productNote.style.display = 'none';
            }
            document.getElementById('vSize').value = data?.size||'';
            document.getElementById('vColor').value = data?.color||'';
            document.getElementById('vStockQuantity').value = data?.stockQuantity||0;
            variantModal?.show();
        }
        async function saveVariant(){
            const id = document.getElementById('vId').value;
            const payload = {
                productId: parseInt(document.getElementById('vProductId').value),
                size: document.getElementById('vSize').value,
                color: document.getElementById('vColor').value,
                stockQuantity: parseInt(document.getElementById('vStockQuantity').value||'0',10)
            };
            try {
                if (id){
                    await fetchJson(`/admin/api/inventory/update/${id}`,{ 
                        method:'POST', 
                        body: JSON.stringify({ 
                            stockQuantity: payload.stockQuantity,
                            Size: payload.size,
                            Color: payload.color
                        }) 
                    });
                } else {
                    await fetchJson('/admin/api/inventory/create',{ method:'POST', body: JSON.stringify(payload) });
                }
                variantModal?.hide();
                await loadInventory();
            } catch(error) {
                alert('Error: ' + error.message);
            }
        }
        async function addVariant(){ 
            await loadProductsForInventory();
            openVariantModal('add'); 
        }
        async function editVariant(id){
            const rows = await fetchJson('/admin/api/inventory');
            const variant = rows.find(v => v.id == id);
            if(variant){
                await loadProductsForInventory();
                openVariantModal('edit', {
                    id: variant.id,
                    productId: variant.productId,
                    size: variant.size,
                    color: variant.color,
                    stockQuantity: variant.stockQuantity
                });
            } else {
                alert('Variant not found');
            }
        }
        async function deleteVariant(id){
            if(!confirm('Delete this variant?')) return;
            try {
                await fetchJson(`/admin/api/inventory/delete/${id}`,{ method:'POST' });
                await loadInventory();
            } catch(error) {
                alert('Error: ' + error.message);
            }
        }
        if (isInventory){
            loadProductsForInventory();
            loadInventory();
            setupInventorySearch();
            document.getElementById('btnReloadStock')?.addEventListener('click', loadInventory);
            document.getElementById('btnAddVariant')?.addEventListener('click', addVariant);
            document.getElementById('saveVariantBtn')?.addEventListener('click', saveVariant);
            window.editVariant = editVariant; 
            window.deleteVariant = deleteVariant;
        }

        // Report minimal
        let reportChart;
        async function loadReport(){
            const from = document.getElementById('repFrom').value;
            const to = document.getElementById('repTo').value;
            const q = new URLSearchParams(); if(from) q.set('from', from); if(to) q.set('to', to);
            const summary = await fetchJson('/admin/api/report/summary?'+q.toString());
            document.getElementById('rRevenue').textContent = fmtUSD(summary.revenueUSD);
            document.getElementById('rOrders').textContent = summary.orders;
            document.getElementById('rItems').textContent = summary.items;
            document.getElementById('rAov').textContent = fmtUSD(summary.aov);

            const series = await fetchJson('/admin/api/report/timeseries?'+q.toString());
            const labels = series.map(x=>x.period);
            const rev = series.map(x=>x.revenueUSD);
            const ord = series.map(x=>x.orders);
            const ctx2 = document.getElementById('reportSeries')?.getContext('2d');
            if (ctx2){
                if(reportChart) reportChart.destroy();
                reportChart = new Chart(ctx2, { type:'bar', data:{ labels, datasets:[
                    { type:'bar', label:'Revenue', data: rev, backgroundColor:'rgba(32,98,233,0.25)', borderColor:'#2062e9' },
                    { type:'line', label:'Orders', data: ord, borderColor:'#ef4a64', yAxisID:'y1' }
                ]}, options:{ responsive:true, scales:{ y1:{ position:'right', grid:{ drawOnChartArea:false } } } } });
            }
        }
        function setDefaultRange(){
            const to = new Date();
            const from = new Date(); from.setDate(to.getDate()-30);
            document.getElementById('repFrom').value = from.toISOString().slice(0,10);
            document.getElementById('repTo').value = to.toISOString().slice(0,10);
        }
        if (isReport){
            setDefaultRange();
            document.getElementById('btnApplyReport')?.addEventListener('click', loadReport);
            loadReport();
        }
</script>
}

