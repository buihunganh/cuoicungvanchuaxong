<!-- Main Header Navigation - Nike style -->
<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
    <div class="container-fluid">
        <!-- Mobile menu button -->
        <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <!-- Logo - Left side -->
        <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index" style="color: #000; font-size: 1.6rem; font-weight: 700; letter-spacing: 0; text-decoration: none;">
            ABDDT
        </a>
        
        <!-- Right side: Search, Wishlist, Cart -->
        <div class="d-none d-lg-flex align-items-center" style="gap: 1rem;">
            <div class="position-relative">
                <form asp-controller="Products" asp-action="Search" method="get" style="display: inline-block;" id="searchForm">
                    <input type="text" name="q" id="searchInput" placeholder="Search" value="" style="width: 150px; border: none; border-bottom: 1px solid #ccc; border-radius: 0; font-size: 0.875rem; color: #000; background: transparent; padding: 5px 25px 5px 0; outline: none;" onfocus="this.style.borderBottomColor='#000'" onblur="this.style.borderBottomColor='#ccc'" />
                    <i class="bi bi-search position-absolute" style="right: 5px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #8C8C8C;"></i>
                </form>
            </div>
            <a href="#" class="text-decoration-none nav-icon" style="color: #000; font-size: 1.3rem;">
                <i class="bi bi-heart"></i>
            </a>
            <a asp-controller="Cart" asp-action="Index" class="text-decoration-none position-relative nav-icon" style="color: #000; font-size: 1.3rem;">
                <i class="bi bi-bag"></i>
                @await Component.InvokeAsync("CartBadge")
            </a>
        </div>
        
        <!-- Mobile: Cart and Wishlist only -->
        <div class="d-lg-none d-flex align-items-center gap-2">
            <a href="#" class="text-decoration-none nav-icon" style="color: #000; font-size: 1.2rem;">
                <i class="bi bi-heart"></i>
            </a>
            <a asp-controller="Cart" asp-action="Index" class="text-decoration-none position-relative nav-icon" style="color: #000; font-size: 1.2rem;">
                <i class="bi bi-bag"></i>
                @await Component.InvokeAsync("CartBadge")
            </a>
        </div>
        
        <!-- Navigation links - Center -->
        <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav mx-auto d-flex align-items-center gap-3">
                <li class="nav-item">
                    <a class="nav-link" asp-area="" asp-controller="Home" asp-action="Index" asp-fragment="features" style="font-weight: 400; font-size: 0.95rem; color: #000;">New & Featured</a>
                </li>
                <li class="nav-item has-mega">
                    <a class="nav-link" asp-controller="Products" asp-action="Men" style="font-weight: 400; font-size: 0.95rem; color: #000;">Men</a>
                    <div class="mega-dropdown" aria-hidden="true">
                        <div class="mega-inner">
                            <div class="mega-columns">
                                <div class="mega-col">
                                    <div class="mega-title">Top Brands</div>
                                    <ul class="mega-list">
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-Nike">Nike</a></li>
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-Adidas">Adidas</a></li>
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-Balenciaga">Balenciaga</a></li>
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-Louboutin">Louboutin</a></li>
                                    </ul>
                                </div>
                                <div class="mega-col">
                                    <div class="mega-title">More Brands</div>
                                    <ul class="mega-list">
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-Puma">Puma</a></li>
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-New-Balance">New Balance</a></li>
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-ASICS">ASICS</a></li>
                                        <li><a asp-controller="Products" asp-action="Men" asp-fragment="brand-Reebok">Reebok</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="nav-item has-mega">
                    <a class="nav-link" asp-controller="Products" asp-action="Women" style="font-weight: 400; font-size: 0.95rem; color: #000;">Women</a>
                    <div class="mega-dropdown" aria-hidden="true">
                        <div class="mega-inner">
                            <div class="mega-columns">
                                <div class="mega-col">
                                    <div class="mega-title">Top Brands</div>
                                    <ul class="mega-list">
                                        <li><a href="#">Nike</a></li>
                                        <li><a href="#">Adidas</a></li>
                                        <li><a href="#">Balenciaga</a></li>
                                        <li><a href="#">Louboutin</a></li>
                                    </ul>
                                </div>
                                <div class="mega-col">
                                    <div class="mega-title">More Brands</div>
                                    <ul class="mega-list">
                                        <li><a href="#">Puma</a></li>
                                        <li><a href="#">New Balance</a></li>
                                        <li><a href="#">ASICS</a></li>
                                        <li><a href="#">Reebok</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
                <li class="nav-item has-mega">
                    <a class="nav-link" asp-controller="Products" asp-action="Kid" style="font-weight: 400; font-size: 0.95rem; color: #000;">Kids</a>
                    <div class="mega-dropdown" aria-hidden="true">
                        <div class="mega-inner">
                            <div class="mega-columns">
                                <div class="mega-col">
                                    <div class="mega-title">Top Brands</div>
                                    <ul class="mega-list">
                                        <li><a href="#">Nike</a></li>
                                        <li><a href="#">Adidas</a></li>
                                        <li><a href="#">Balenciaga</a></li>
                                        <li><a href="#">Louboutin</a></li>
                                    </ul>
                                </div>
                                <div class="mega-col">
                                    <div class="mega-title">More Brands</div>
                                    <ul class="mega-list">
                                        <li><a href="#">Puma</a></li>
                                        <li><a href="#">New Balance</a></li>
                                        <li><a href="#">ASICS</a></li>
                                        <li><a href="#">Reebok</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Order modal (shared) -->
<div id="orderModal" class="order-modal" aria-hidden="true">
  <div class="overlay" aria-hidden="true"></div>
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="orderModalName">
    <button type="button" class="order-modal-close" aria-label="Close">&times;</button>
    <div class="order-modal-body">
      <div class="d-flex flex-column flex-md-row gap-3 align-items-start">
        <div class="product-preview w-100 w-md-auto">
          <img id="orderModalImage" src="" alt="" class="img-fluid" />
        </div>
        <div class="flex-grow-1 w-100">
          <h5 id="orderModalName" class="mb-1">Product name</h5>
          <div id="orderModalPrice" class="text-muted mb-3">$0</div>
          <div id="orderModalCode" class="text-muted small mb-3" style="display: none;">Product ID: #<span id="orderModalCodeValue"></span></div>

          <div class="mb-2" id="sizeFieldContainer" style="display: none;">
            <label for="orderSize">Size</label>
            <select id="orderSize" class="form-control"></select>
          </div>
          <div class="mb-2" id="colorFieldContainer" style="display: none;">
            <label for="orderColor">Color</label>
            <select id="orderColor" class="form-control"></select>
          </div>
          <div class="mb-2" id="qtyFieldContainer" style="display: none;">
            <label for="orderQty">Quantity</label>
            <input id="orderQty" type="number" min="1" value="1" class="form-control" />
          </div>
        </div>
      </div>

      <div class="mt-3">
        <button id="addToCartBtn" class="add-to-cart-btn">Add to cart</button>
      </div>
    </div>
  </div>
</div>

@{
    var isAuth = (Context != null && Context.Session.GetInt32("UserId") != null) ? "true" : "false";
}

<script>
// expose auth flag from server
window.isAuthenticated = @isAuth;
(function(){
    async function updateCartBadge(){
        const badge = document.getElementById('cartBadge');
        if(!badge) return;
        try{
            if(window.isAuthenticated){
                const res = await fetch('/Cart/GetCartCount');
                if(res.ok){
                    const j = await res.json();
                    badge.textContent = (j.count || 0);
                    badge.style.display = (j.count > 0) ? 'inline' : 'none';
                    return;
                }
            }
            // fallback: localStorage
            const cart = JSON.parse(localStorage.getItem('cart')||'[]');
            badge.textContent = cart.length || 0;
            badge.style.display = (cart.length > 0) ? 'inline' : 'none';
        }catch(e){ badge.textContent = 0; badge.style.display = 'none'; }
    }
    // Update cart badge after page interactions
    updateCartBadge();

    const modal = document.getElementById('orderModal');
    if(!modal) return;
    const overlay = modal.querySelector('.overlay');
    const closeBtn = modal.querySelector('.order-modal-close');
    const imgEl = modal.querySelector('#orderModalImage');
    const nameEl = modal.querySelector('#orderModalName');
    const priceEl = modal.querySelector('#orderModalPrice');
    const codeEl = modal.querySelector('#orderModalCode');
    const codeValueEl = modal.querySelector('#orderModalCodeValue');
    const sizeEl = modal.querySelector('#orderSize');
    const colorEl = modal.querySelector('#orderColor');
    const qtyEl = modal.querySelector('#orderQty');
    const sizeContainer = modal.querySelector('#sizeFieldContainer');
    const colorContainer = modal.querySelector('#colorFieldContainer');
    const qtyContainer = modal.querySelector('#qtyFieldContainer');
    const addBtn = modal.querySelector('#addToCartBtn');
    
    let currentVariants = [];

    function showModal(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function hideModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
    
    async function loadProductVariants(productId) {
        if(!productId || productId === '0' || productId === '') {
            // Hide all fields if no product ID
            if(sizeContainer) sizeContainer.style.display = 'none';
            if(colorContainer) colorContainer.style.display = 'none';
            if(qtyContainer) qtyContainer.style.display = 'none';
            return;
        }
        
        try {
            const response = await fetch(`/Products/GetProductVariants?productId=${productId}`);
            const data = await response.json();
            
            if(data.success && data.variants && data.variants.length > 0) {
                currentVariants = data.variants;
                
                // Populate Size dropdown
                if(data.sizes && data.sizes.length > 0 && sizeEl && sizeContainer) {
                    sizeEl.innerHTML = '<option value="">Select Size</option>';
                    data.sizes.forEach(size => {
                        const option = document.createElement('option');
                        option.value = size;
                        option.textContent = size;
                        sizeEl.appendChild(option);
                    });
                    sizeContainer.style.display = 'block';
                } else if(sizeContainer) {
                    sizeContainer.style.display = 'none';
                }
                
                // Populate Color dropdown
                if(data.colors && data.colors.length > 0 && colorEl && colorContainer) {
                    colorEl.innerHTML = '<option value="">Select Color</option>';
                    data.colors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = color;
                        option.textContent = color;
                        colorEl.appendChild(option);
                    });
                    colorContainer.style.display = 'block';
                } else if(colorContainer) {
                    colorContainer.style.display = 'none';
                }
                
                // Show quantity field if variants exist
                if(qtyContainer) {
                    qtyContainer.style.display = 'block';
                    if(qtyEl) {
                        qtyEl.value = 1;
                        qtyEl.max = ''; // Will be set based on selected variant
                    }
                }
                
                // Update max quantity when size/color changes (remove old listeners first)
                if(sizeEl) {
                    sizeEl.removeEventListener('change', updateMaxQuantity);
                    sizeEl.addEventListener('change', updateMaxQuantity);
                }
                if(colorEl) {
                    colorEl.removeEventListener('change', updateMaxQuantity);
                    colorEl.addEventListener('change', updateMaxQuantity);
                }
                
                // Initial quantity update
                updateMaxQuantity();
                
            } else {
                // No variants in database - hide all fields
                if(sizeContainer) sizeContainer.style.display = 'none';
                if(colorContainer) colorContainer.style.display = 'none';
                if(qtyContainer) qtyContainer.style.display = 'none';
            }
        } catch(error) {
            console.error('Error loading product variants:', error);
            // Hide fields on error
            if(sizeContainer) sizeContainer.style.display = 'none';
            if(colorContainer) colorContainer.style.display = 'none';
            if(qtyContainer) qtyContainer.style.display = 'none';
        }
    }
    
    function updateMaxQuantity() {
        if(!qtyEl || !currentVariants || currentVariants.length === 0) return;
        
        const selectedSize = sizeEl ? sizeEl.value : '';
        const selectedColor = colorEl ? colorEl.value : '';
        
        // Find matching variant
        const variant = currentVariants.find(v => 
            (!selectedSize || v.size === selectedSize) && 
            (!selectedColor || v.color === selectedColor)
        );
        
        if(variant && variant.stockQuantity > 0) {
            qtyEl.max = variant.stockQuantity;
            if(parseInt(qtyEl.value) > variant.stockQuantity) {
                qtyEl.value = variant.stockQuantity;
            }
        } else {
            qtyEl.max = '';
        }
    }

    document.addEventListener('click', function(e){
        const btn = e.target.closest('.order-btn');
        if(!btn) return;
        e.preventDefault();
        const item = btn.closest('.product-item');
        if(!item) return;

        const name = item.querySelector('.card-body h5')?.textContent?.trim() || item.getAttribute('data-name') || '';
        
        // Get price - ALWAYS prioritize data-price attribute (raw number from DB) to avoid parsing errors
        let priceNum = 0;
        
        // FIRST: Get from data-price attribute - this is the accurate raw price from database
        const dataPrice = item.getAttribute('data-price');
        if (dataPrice) {
            // data-price is already a number, just parse it
            priceNum = parseFloat(dataPrice.toString().trim()) || 0;
        }
        
        // SECOND: If no data-price, try to parse from displayed price text
        if (!priceNum) {
            // Check for discount price first (displayed in red text-danger class)
            const discountPriceEl = item.querySelector('.card-body .text-danger.fw-bold');
            const priceEl = discountPriceEl || item.querySelector('.card-body .fw-bold:not(.text-danger)');
            
            if (priceEl) {
                const priceText = priceEl.textContent || '';
                // Remove $ sign first
                let cleanedPrice = priceText.replace('$', '').trim();
                
                // Handle European format (comma as decimal): "120,00" -> "120.00"
                // If comma is followed by exactly 2 digits at the end, it's decimal separator
                if (/,\d{2}$/.test(cleanedPrice)) {
                    cleanedPrice = cleanedPrice.replace(',', '.');
                }
                // Handle thousand separators: if comma has 3 digits after it, it's thousand separator
                else if (/,\d{3}/.test(cleanedPrice) && !/\.\d/.test(cleanedPrice)) {
                    // Has comma with 3 digits after (thousand separator) and no dot = US format with comma
                    cleanedPrice = cleanedPrice.replace(/,/g, '');
                }
                // If has both comma and dot: comma is thousand, dot is decimal
                else if (/,/.test(cleanedPrice) && /\./.test(cleanedPrice)) {
                    // US format: "1,200.50" - remove commas (thousand), keep dot (decimal)
                    cleanedPrice = cleanedPrice.replace(/,/g, '');
                }
                // Otherwise, if only comma and not at end with 2 digits, it might be thousand separator
                else if (/,/.test(cleanedPrice) && !/,\d{2}$/.test(cleanedPrice)) {
                    cleanedPrice = cleanedPrice.replace(/,/g, '');
                }
                
                priceNum = parseFloat(cleanedPrice) || 0;
            }
        }
        
        const img = item.querySelector('.card-thumb-img')?.getAttribute('src') || item.querySelector('img')?.getAttribute('src') || '';
        const productId = item.getAttribute('data-product-id') || '';
        
        if(imgEl) imgEl.src = img;
        if(nameEl) nameEl.textContent = name;
        
        // Format price for display - always show 2 decimal places
        if(priceEl) priceEl.textContent = '$' + priceNum.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // Display Product ID if available
        if(productId && codeValueEl && codeEl) {
            codeValueEl.textContent = productId;
            codeEl.style.display = 'block';
        } else if(codeEl) {
            codeEl.style.display = 'none';
        }

        // Load variants from database
        loadProductVariants(productId);

        modal.dataset.name = name; modal.dataset.price = priceNum.toString(); modal.dataset.img = img; modal.dataset.productId = productId;

        showModal();
    });

    overlay.addEventListener('click', hideModal);
    closeBtn.addEventListener('click', hideModal);
    document.addEventListener('keydown', function(e){ if(e.key==='Escape' && modal.classList.contains('show')) hideModal(); });

    addBtn.addEventListener('click', async function(){
        // Get price directly from dataset which should be a clean number string
        const priceFromDataset = parseFloat(modal.dataset.price || '0') || 0;
        
        const item = {
            name: modal.dataset.name || nameEl.textContent,
            price: priceFromDataset, // Use parsed price directly
            img: modal.dataset.img || imgEl.src,
            size: (sizeEl?.value || '').trim(),
            color: (colorEl?.value || '').trim(),
            qty: parseInt(qtyEl?.value||1,10),
            productId: modal.dataset.productId || null
        };

        if(!window.isAuthenticated){
            // show toast and redirect to login
            const toast = document.createElement('div');
            toast.textContent = 'Please sign in before adding to cart';
            toast.style.cssText = 'position:fixed;right:20px;bottom:20px;background:#ef4a64;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999;box-shadow:0 8px 20px rgba(0,0,0,0.2);';
            document.body.appendChild(toast);
            setTimeout(()=>{ toast.remove(); window.location.href = '/Account/Login'; },1200);
            return;
        }

        // Price is already parsed and stored in item.price as number
        const priceValue = item.price;

        // send to server using form-encoded POST to Cart/AddToCart
        try{
            const form = new URLSearchParams();
            form.append('productId', item.productId || '0');
            form.append('productName', item.name || '');
            form.append('price', priceValue.toString());
            form.append('imageUrl', item.img || '');
            form.append('quantity', (item.qty||1).toString());
            form.append('size', item.size || '');
            form.append('color', item.color || '');

            const res = await fetch('/Cart/AddToCart', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: form.toString() });
            if(res.ok){
                const j = await res.json();
                updateCartBadge();
                hideModal();
                const toast = document.createElement('div');
                toast.textContent = 'Added to cart';
                toast.style.cssText = 'position:fixed;right:20px;bottom:20px;background:#111;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999;box-shadow:0 8px 20px rgba(0,0,0,0.2);';
                document.body.appendChild(toast);
                setTimeout(()=>toast.remove(),1600);
            } else {
                const txt = await res.text();
                alert('Failed to add to cart: '+txt);
            }
        }catch(e){ alert('Error adding to cart'); }
    });
})();

// Search functionality
(function(){
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    
    if(searchForm && searchInput){
        searchInput.addEventListener('keypress', function(e){
            if(e.key === 'Enter'){
                e.preventDefault();
                const query = this.value.trim();
                if(query.length > 0){
                    searchForm.submit();
                }
            }
        });
        
        searchInput.addEventListener('blur', function(){
            const query = this.value.trim();
            if(query.length === 0){
                this.value = '';
            }
        });
    }
})();
</script>

